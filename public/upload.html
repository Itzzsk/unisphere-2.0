<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>UniSphere Admin Banner</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { press: ['"Press Start 2P"', 'cursive'] },
          colors: { nightTop: '#0F172A', nightBottom: '#1E293B' },
          boxShadow: { 'inner-glow':'inset 0 0 6px 0 rgba(0,0,0,.35)' }
        }
      }
    };
  </script>

  <!-- Firebase compat v9 -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <!-- Icons & font -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    html,body{height:100%}
    body{background:linear-gradient(135deg,#e9f0ff 0%,#dbeafe 40%,#bfdbfe 100%);}
    body.dark{background:linear-gradient(135deg,var(--tw-color-nightTop),var(--tw-color-nightBottom));}
  </style>
</head>

<body class="min-h-full flex items-center justify-center text-slate-900 dark:text-slate-100 transition-colors duration-300">

<!-- LOGIN CARD -->
<section id="loginSection" class="w-full max-w-sm p-8 space-y-4 rounded-2xl bg-white/70 dark:bg-slate-800/70 backdrop-blur shadow-xl shadow-inner-glow">

  <h1 class="font-press text-xs tracking-widest flex items-center justify-center gap-2">
    <i class="fa-solid fa-user-astronaut text-blue-500 text-lg"></i>UniSphere
  </h1>

  <h2 class="text-xl font-bold text-center">Admin Login</h2>

  <input id="email" type="email" placeholder="Email" class="w-full px-4 py-3 rounded-lg bg-white/80 dark:bg-slate-700/70 border focus:ring-2 focus:ring-blue-500 outline-none"/>

  <input id="password" type="password" placeholder="Password" class="w-full px-4 py-3 rounded-lg bg-white/80 dark:bg-slate-700/70 border focus:ring-2 focus:ring-blue-500 outline-none"/>

  <button id="loginBtn" onclick="login()" class="w-full py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-colors">Login</button>

  <p id="loginError" class="hidden text-sm text-center text-red-400"></p>
</section>

<!-- BANNER UPLOAD CARD -->
<section id="uploadSection" class="hidden w-full max-w-md p-8 space-y-8 rounded-2xl bg-white/70 dark:bg-slate-800/70 backdrop-blur shadow-xl shadow-inner-glow">

  <div class="flex items-center justify-between">
    <h2 class="text-xl font-bold">Admin Panel</h2>
    <button onclick="logout()" class="px-4 py-2 text-sm rounded-lg bg-red-500 hover:bg-red-600 text-white">Logout</button>
  </div>

  <div>
    <h3 class="text-lg font-bold text-center mb-6">Upload Banner</h3>

    <form id="uploadBannerForm" class="space-y-3">
      <!-- Image Upload -->
      <input id="bannerImage" type="file" accept="image/*" class="w-full rounded-lg bg-white/80 dark:bg-slate-700/70 border p-3" required>

      <!-- URL Input -->
      <input id="bannerLink" type="url" placeholder="Enter URL (e.g., google.com)" class="w-full rounded-lg bg-white/80 dark:bg-slate-700/70 border p-3" required>

      <!-- Submit Button -->
      <button type="submit" class="w-full py-3 rounded-lg bg-lime-400 hover:bg-lime-500 text-slate-900 font-semibold transition-colors">Update Banner</button>
    </form>

    <!-- Image Preview -->
    <div id="bannerPreview" class="mt-4"></div>
  </div>
</section>

<script>
// Firebase Configuration
firebase.initializeApp({
  apiKey: "AIzaSyAn172ndihcZRqCBAxKYATkc3Hf_uNi4hw",
  authDomain: "unisphere-35100.firebaseapp.com",
  projectId: "unisphere-35100"
});

const auth = firebase.auth();
const $ = id => document.getElementById(id);

// Auth State Management
auth.onAuthStateChanged(user => user ? showUpload() : showLogin());

function showLogin() {
  loginSection.classList.remove('hidden');
  uploadSection.classList.add('hidden');
}

function showUpload() {
  loginSection.classList.add('hidden');
  uploadSection.classList.remove('hidden');
}

// Login Function
async function login() {
  const email = $('email').value.trim();
  const pass = $('password').value.trim();
  
  loginError.classList.add('hidden');
  
  if (!email || !pass) {
    loginError.textContent = 'Please fill both fields';
    loginError.classList.remove('hidden');
    return;
  }

  toggleBtn(true, loginBtn, 'Logging in...');
  
  try {
    await auth.signInWithEmailAndPassword(email, pass);
  } catch (e) {
    loginError.textContent = mapErr(e);
    loginError.classList.remove('hidden');
  } finally {
    toggleBtn(false, loginBtn, 'Login');
  }
}

// Logout Function
function logout() {
  auth.signOut();
}

// Error Message Mapping
function mapErr(e) {
  switch (e.code) {
    case 'auth/user-not-found': return 'No user found with this email';
    case 'auth/wrong-password': return 'Incorrect password';
    case 'auth/invalid-email': return 'Invalid email address';
    case 'auth/too-many-requests': return 'Too many attempts. Try again later';
    default: return e.message;
  }
}

// Image Preview
bannerImage.onchange = () => {
  bannerPreview.innerHTML = '';
  const file = bannerImage.files[0];
  
  if (!file) return;
  
  if (file.size > 5 * 1024 * 1024) {
    alert('File size must be less than 5MB');
    bannerImage.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = e => {
    bannerPreview.innerHTML = `<img src="${e.target.result}" class="rounded w-full max-h-56 object-contain border mt-2" alt="Banner Preview">`;
  };
  reader.readAsDataURL(file);
};

// In your admin panel upload function
uploadBannerForm.addEventListener('submit', async e => {
  e.preventDefault();
  
  if (!bannerImage.files.length) { 
    alert('Choose an image'); 
    return; 
  }
  
  if (!bannerLink.value.trim()) { 
    alert('Enter a URL'); 
    return; 
  }

  const btn = uploadBannerForm.querySelector('button');
  toggleBtn(true, btn, 'Uploading...');
  
  try {
    const fd = new FormData();
    fd.append('banner', bannerImage.files[0]);  // File field
    fd.append('link', bannerLink.value.trim()); // Text field
    
    // Debug: Log what we're sending
    console.log('ðŸ“¤ Sending to server:', {
      hasFile: !!bannerImage.files,
      fileName: bannerImage.files?.name,
      linkValue: bannerLink.value.trim()
    });

    const res = await fetch('/api/upload/banner', { 
      method: 'POST', 
      body: fd 
    });
    
    const result = await res.json();
    
    if (res.ok && result.success) {
      alert('âœ… ' + result.message);
      // Clear form
      bannerImage.value = '';
      bannerLink.value = '';
      bannerPreview.innerHTML = '';
    } else {
      alert('âŒ ' + result.message);
    }
    
  } catch (err) {
    console.error('Upload error:', err);
    alert('Upload failed: ' + err.message);
  } finally {
    toggleBtn(false, btn, 'Update Banner');
  }
});

// Button Toggle Helper
function toggleBtn(disabled, btn, label) {
  btn.disabled = disabled;
  btn.textContent = label;
}

// Add click handler to test banner functionality
document.addEventListener('DOMContentLoaded', () => {
  console.log('âœ… Admin panel loaded successfully');
  console.log('ðŸ“‹ Upload both image and URL to create clickable banner');
});
</script>

</body>
</html>
